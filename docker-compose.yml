services:
  db1:
    image: postgres:16
    container_name: db1
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${DB1_NAME}
    ports:
      - "${DB1_PORT}:5432"
    volumes:
      - db1_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  db2:
    image: postgres:16
    container_name: db2
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${DB2_NAME}
    ports:
      - "${DB2_PORT}:5432"
    volumes:
      - db2_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  db3:
    image: postgres:16
    container_name: db3
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${DB3_NAME}
    ports:
      - "${DB3_PORT}:5432"
    volumes:
      - db3_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  node1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: node1
    restart: always
    depends_on:
      - db1
    environment:
      NODE_NAME: node1
      NODE_ROLE: CENTRAL
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db1:5432/${DB1_NAME}
      PORT: ${NODE_PORT}
      CENTRAL_URL: http://node1:${NODE_PORT}
      NODE2_URL: http://node2:${NODE_PORT}
      NODE3_URL: http://node3:${NODE_PORT}
    ports:
      - "${NODE1_HOST_PORT}:${NODE_PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${NODE_PORT}/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  node2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: node2
    restart: always
    depends_on:
      - db2
    environment:
      NODE_NAME: node2
      NODE_ROLE: FRAGMENT
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db2:5432/${DB2_NAME}
      PORT: ${NODE_PORT}
      CENTRAL_URL: http://node1:${NODE_PORT}
    ports:
      - "${NODE2_HOST_PORT}:${NODE_PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${NODE_PORT}/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  node3:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: node3
    restart: always
    depends_on:
      - db3
    environment:
      NODE_NAME: node3
      NODE_ROLE: FRAGMENT
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db3:5432/${DB3_NAME}
      PORT: ${NODE_PORT}
      CENTRAL_URL: http://node1:${NODE_PORT}
    ports:
      - "${NODE3_HOST_PORT}:${NODE_PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${NODE_PORT}/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  db1_data:
  db2_data:
  db3_data:
